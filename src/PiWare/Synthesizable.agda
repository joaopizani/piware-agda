open import PiWare.Atom

module PiWare.Synthesizable (AI : AtomInfo) where

open module AI' = AtomInfo AI

open import Function using (_$_; _âˆ˜_)
open import Data.Sum using (_âŠ_; injâ‚; injâ‚‚)
open import Data.Product using (_Ã—_; _,_)
open import Data.Bool using (false; true; if_then_else_)
open import Data.Fin using (Fin; fromâ„•â‰¤; toâ„•; _â„•-_) renaming (zero to Fz; suc to Fs)
open import Data.Nat using (â„•; _+_; _*_; _â‰¤?_; zâ‰¤n; sâ‰¤s; zero; suc; _â‰¤_; _âŠ”_)
open import Data.Vec using (Vec; _++_; splitAt; _>>=_; group; concat; map; take; replicate)
                     renaming ([] to Îµ; _âˆ·_ to _â—_)

open import Relation.Nullary using (yes; no; Â¬_)
open import Relation.Nullary.Negation using (contradiction)
open import Relation.Binary.PropositionalEquality using (refl)


-- Words are sequences of "Atoms"
ğ• : â„• â†’ Set
ğ• = Vec Atom


-- Provides a mapping between "high-level" metalanguage types and words
record â‡“ğ•â‡‘ (Î± : Set) {#Î± : â„•} : Set where
    constructor â‡“ğ•â‡‘[_,_]
    field
        â‡“ : Î± â†’ ğ• #Î±
        â‡‘ : ğ• #Î± â†’ Î±

open â‡“ğ•â‡‘ {{...}}

-- basic instances
â‡“ğ•â‡‘-Ã— : {Î± Î² : Set} {#Î± #Î² : â„•} â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ _ : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â†’ â‡“ğ•â‡‘ (Î± Ã— Î²)
â‡“ğ•â‡‘-Ã— {Î±} {Î²} {#Î±} {#Î²} = â‡“ğ•â‡‘[ down , up ]
    where down : (Î± Ã— Î²) â†’ ğ• (#Î± + #Î²)
          down (a , b) = (â‡“ a) ++ (â‡“ b)

          up : ğ• (#Î± + #Î²) â†’ (Î± Ã— Î²)
          up atoms with splitAt #Î± atoms
          up .(â‡“a ++ â‡“b) | â‡“a , â‡“b , refl = (â‡‘ â‡“a) , (â‡‘ â‡“b)

padding : (#Î± #Î² actual : â„•) {actual â‰¤ #Î± âŠ” #Î²} â†’ â„•
padding #Î± #Î² actual = 

â‡“ğ•â‡‘-âŠ : {Î± Î² : Set} {#Î± #Î² : â„•} â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ _ : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â†’ â‡“ğ•â‡‘ (Î± âŠ Î²)
â‡“ğ•â‡‘-âŠ {Î±} {Î²} {#Î±} {#Î²} = â‡“ğ•â‡‘ [ down , up ]
    where #[Î±âŠÎ²] = suc (#Î± âŠ” #Î²)

          down : (Î± âŠ Î²) â†’ ğ• #[Î±âŠÎ²]
          down (injâ‚ a) = atom# (# 0) â— â‡“ a
          down (injâ‚‚ b) = atom# (# 1) â— â‡“ b

          up : ğ• #[Î±âŠÎ²] â†’ (Î± âŠ Î²)
          up (tag â— )

â‡“ğ•â‡‘-Vec : {Î± : Set} {#Î± n : â„•} â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â†’ â‡“ğ•â‡‘ (Vec Î± n)
â‡“ğ•â‡‘-Vec {Î±} {#Î±} {n} = â‡“ğ•â‡‘[ down , up ]
    where down : Vec Î± n â†’ ğ• (n * #Î±)
          down v = v >>= â‡“

          up : ğ• (n * #Î±) â†’ Vec Î± n
          up atoms with group n #Î± atoms
          up .(concat grps) | grps , refl = map â‡‘ grps

Â¬aâ‰¤bâ†’bâ‰¤a : {n m : â„•} â†’ Â¬ (n â‰¤ m) â†’ (m â‰¤ n)
Â¬aâ‰¤bâ†’bâ‰¤a {_}     {zero}  _  = zâ‰¤n
Â¬aâ‰¤bâ†’bâ‰¤a {zero}  {suc m} Â¬p = contradiction (zâ‰¤n) Â¬p
Â¬aâ‰¤bâ†’bâ‰¤a {suc n} {suc m} Â¬p = sâ‰¤s $ Â¬aâ‰¤bâ†’bâ‰¤a (Â¬p âˆ˜ sâ‰¤s)

pad : (a b : â„•) â†’ â„•
pad a b with a â‰¤? b
pad a b | yes p = toâ„• $ b â„•- (fromâ„•â‰¤ (sâ‰¤s p))
pad a b | no Â¬p = toâ„• $ a â„•- (fromâ„•â‰¤ (sâ‰¤s $ Â¬aâ‰¤bâ†’bâ‰¤a Â¬p))

â‡“ğ•â‡‘-âŠ : {Î± Î² : Set} {#Î± #Î² : â„•} â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ _ : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â†’ â‡“ğ•â‡‘ (Î± âŠ Î²)
â‡“ğ•â‡‘-âŠ {Î±} {Î²} {#Î±} {#Î²} = â‡“ğ•â‡‘[ down , up ]
    where #[Î±âŠÎ²] = suc (#Î± âŠ” #Î²)

          down : Î± âŠ Î² â†’ ğ• #[Î±âŠÎ²]
          down (injâ‚ a) = ğ”¹â†’atom false â— (â‡“ a ++ replicate (ğ”¹â†’atom false))
          down (injâ‚‚ b) = ğ”¹â†’atom true  â— (â‡“ b ++ replicate (ğ”¹â†’atom false))
          
          up : ğ• #[Î±âŠÎ²] â†’ Î± âŠ Î²
          up (t â— ab) = if (atomâ†’ğ”¹ t) then injâ‚‚ (â‡‘ (take #Î± ab)) else injâ‚ (â‡‘ (take #Î² ab))


-- derivable instances (can be resolved recursively from the basic)
â‡“ğ•â‡‘-aÃ—[bÃ—c] : {Î± Î² Î³ : Set} {#Î± #Î² #Î³ : â„•}
               â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„
               â†’ â‡“ğ•â‡‘ (Î± Ã— (Î² Ã— Î³))
â‡“ğ•â‡‘-aÃ—[bÃ—c] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-Ã— â¦„

â‡“ğ•â‡‘-[aÃ—b]Ã—c : {Î± Î² Î³ : Set} {#Î± #Î² #Î³ : â„•}
               â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„
               â†’ â‡“ğ•â‡‘ ((Î± Ã— Î²) Ã— Î³)
â‡“ğ•â‡‘-[aÃ—b]Ã—c â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-Ã— â¦„ â¦ƒ sÎ³ â¦„


â‡“ğ•â‡‘-aÃ—[bÃ—[cÃ—d]] : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ (Î± Ã— (Î² Ã— (Î³ Ã— Î´)))
â‡“ğ•â‡‘-aÃ—[bÃ—[cÃ—d]] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-aÃ—[bÃ—c] â¦„

â‡“ğ•â‡‘-aÃ—[[bÃ—c]Ã—d] : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ (Î± Ã— ((Î² Ã— Î³) Ã— Î´))
â‡“ğ•â‡‘-aÃ—[[bÃ—c]Ã—d] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-[aÃ—b]Ã—c â¦„

â‡“ğ•â‡‘-[aÃ—b]Ã—[cÃ—d] : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ ((Î± Ã— Î²) Ã— (Î³ Ã— Î´))
â‡“ğ•â‡‘-[aÃ—b]Ã—[cÃ—d] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-Ã— â¦„ â¦ƒ â‡“ğ•â‡‘-Ã— â¦„

â‡“ğ•â‡‘-[aÃ—[bÃ—c]]Ã—d : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ ((Î± Ã— (Î² Ã— Î³)) Ã— Î´)
â‡“ğ•â‡‘-[aÃ—[bÃ—c]]Ã—d â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-aÃ—[bÃ—c] â¦„ â¦ƒ sÎ´ â¦„

â‡“ğ•â‡‘-[[aÃ—b]Ã—c]Ã—d : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ (((Î± Ã— Î²) Ã— Î³) Ã— Î´)
â‡“ğ•â‡‘-[[aÃ—b]Ã—c]Ã—d â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-[aÃ—b]Ã—c â¦„ â¦ƒ sÎ´ â¦„


â‡“ğ•â‡‘-aÃ—[Vec[b]] : {Î± Î² : Set} {#Î± #Î² : â„•} {n : â„•} â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„
                  â†’ â‡“ğ•â‡‘ (Î± Ã— Vec Î² n)
â‡“ğ•â‡‘-aÃ—[Vec[b]] {n = k} â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-Vec â¦„

â‡“ğ•â‡‘-Vec[a]Ã—b : {Î± Î² : Set} {#Î± #Î² : â„•} {n : â„•} â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„
                â†’ â‡“ğ•â‡‘ (Vec Î± n Ã— Î²)
â‡“ğ•â‡‘-Vec[a]Ã—b {n = k} â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-Vec â¦„ â¦ƒ sÎ² â¦„

â‡“ğ•â‡‘-Vec[aÃ—b] : {Î± Î² : Set} {#Î± #Î² : â„•} {n : â„•} â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„
                â†’ â‡“ğ•â‡‘ (Vec (Î± Ã— Î²) n)
â‡“ğ•â‡‘-Vec[aÃ—b] {n = k} â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ = â‡“ğ•â‡‘-Vec {n = k} â¦ƒ â‡“ğ•â‡‘-Ã— â¦„ 
