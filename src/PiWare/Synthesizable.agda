module PiWare.Synthesizable (Atom : Set) where

open import Data.Product using (_Ã—_; _,_)
open import Data.Nat using (â„•; _+_; _*_)
open import Data.Vec using (Vec; _++_; splitAt; _>>=_; group; concat; map)

open import Relation.Binary.PropositionalEquality using (refl)


-- Binary words
ğ• : â„• â†’ Set
ğ• n = Vec Atom n


-- Provides a mapping between "high-level" metalanguage types and vectors of bits
record â‡“ğ•â‡‘ (Î± : Set) {#Î± : â„•} : Set where
    constructor â‡“ğ•â‡‘[_,_]
    field
        â‡“ : Î± â†’ Vec Atom #Î±  -- to bit vectors
        â‡‘ : Vec Atom #Î± â†’ Î±  -- from bit vectors

open â‡“ğ•â‡‘ {{...}}

â‡“ğ•â‡‘-Ã— : {Î± Î² : Set} {#Î± #Î² : â„•} â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ _ : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â†’ â‡“ğ•â‡‘ (Î± Ã— Î²) {#Î± + #Î²}
â‡“ğ•â‡‘-Ã— {Î±} {Î²} {#Î±} {#Î²} = â‡“ğ•â‡‘[ down , up ]
    where down : (Î± Ã— Î²) â†’ ğ• (#Î± + #Î²)
          down (a , b) = (â‡“ a) ++ (â‡“ b)

          up : ğ• (#Î± + #Î²) â†’ (Î± Ã— Î²)
          up atoms with splitAt #Î± atoms
          up .(â‡“a ++ â‡“b) | â‡“a , â‡“b , refl = (â‡‘ â‡“a) , (â‡‘ â‡“b)

â‡“ğ•â‡‘-Vec : {Î± : Set} {#Î± n : â„•} â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â†’ â‡“ğ•â‡‘ (Vec Î± n) {n * #Î±}
â‡“ğ•â‡‘-Vec {Î±} {#Î±} {n} = â‡“ğ•â‡‘[ down , up ]
    where down : Vec Î± n â†’ ğ• _
          down v = v >>= â‡“

          up : ğ• _ â†’ Vec Î± n
          up atoms with group n #Î± atoms
          up .(concat grps) | grps , refl = map â‡‘ grps



-- TODO: Should we also put "derivable" instances here?
-- Recursive instance resolution is on the way for Agda...
â‡“ğ•â‡‘-aÃ—[bÃ—c] : {Î± Î² Î³ : Set} {#Î± #Î² #Î³ : â„•}
               â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„
               â†’ â‡“ğ•â‡‘ (Î± Ã— (Î² Ã— Î³))
â‡“ğ•â‡‘-aÃ—[bÃ—c] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-Ã— â¦„

â‡“ğ•â‡‘-[aÃ—b]Ã—c : {Î± Î² Î³ : Set} {#Î± #Î² #Î³ : â„•}
               â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„
               â†’ â‡“ğ•â‡‘ ((Î± Ã— Î²) Ã— Î³)
â‡“ğ•â‡‘-[aÃ—b]Ã—c â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-Ã— â¦„ â¦ƒ sÎ³ â¦„


â‡“ğ•â‡‘-aÃ—[bÃ—[cÃ—d]] : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ (Î± Ã— (Î² Ã— (Î³ Ã— Î´)))
â‡“ğ•â‡‘-aÃ—[bÃ—[cÃ—d]] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-aÃ—[bÃ—c] â¦„

â‡“ğ•â‡‘-aÃ—[[bÃ—c]Ã—d] : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ (Î± Ã— ((Î² Ã— Î³) Ã— Î´))
â‡“ğ•â‡‘-aÃ—[[bÃ—c]Ã—d] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-[aÃ—b]Ã—c â¦„

â‡“ğ•â‡‘-[aÃ—b]Ã—[cÃ—d] : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ ((Î± Ã— Î²) Ã— (Î³ Ã— Î´))
â‡“ğ•â‡‘-[aÃ—b]Ã—[cÃ—d] â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-Ã— â¦„ â¦ƒ â‡“ğ•â‡‘-Ã— â¦„

â‡“ğ•â‡‘-[aÃ—[bÃ—c]]Ã—d : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ ((Î± Ã— (Î² Ã— Î³)) Ã— Î´)
â‡“ğ•â‡‘-[aÃ—[bÃ—c]]Ã—d â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-aÃ—[bÃ—c] â¦„ â¦ƒ sÎ´ â¦„

â‡“ğ•â‡‘-[[aÃ—b]Ã—c]Ã—d : {Î± Î² Î³ Î´ : Set} {#Î± #Î² #Î³ #Î´ : â„•}
                 â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
                 â†’ â‡“ğ•â‡‘ (((Î± Ã— Î²) Ã— Î³) Ã— Î´)
â‡“ğ•â‡‘-[[aÃ—b]Ã—c]Ã—d â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-[aÃ—b]Ã—c â¦„ â¦ƒ sÎ´ â¦„


â‡“ğ•â‡‘-aÃ—[Vec[b]] : {Î± Î² : Set} {#Î± #Î² : â„•} {n : â„•} â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„
                  â†’ â‡“ğ•â‡‘ (Î± Ã— Vec Î² n)
â‡“ğ•â‡‘-aÃ—[Vec[b]] {n = k} â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ â‡“ğ•â‡‘-Vec â¦„

â‡“ğ•â‡‘-Vec[a]Ã—b : {Î± Î² : Set} {#Î± #Î² : â„•} {n : â„•} â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„
                â†’ â‡“ğ•â‡‘ (Vec Î± n Ã— Î²)
â‡“ğ•â‡‘-Vec[a]Ã—b {n = k} â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ = â‡“ğ•â‡‘-Ã— â¦ƒ â‡“ğ•â‡‘-Vec â¦„ â¦ƒ sÎ² â¦„

â‡“ğ•â‡‘-Vec[aÃ—b] : {Î± Î² : Set} {#Î± #Î² : â„•} {n : â„•} â†’ â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„
                â†’ â‡“ğ•â‡‘ (Vec (Î± Ã— Î²) n)
â‡“ğ•â‡‘-Vec[aÃ—b] {n = k} â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ = â‡“ğ•â‡‘-Vec {n = k} â¦ƒ â‡“ğ•â‡‘-Ã— â¦„ 
