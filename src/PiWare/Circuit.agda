module PiWare.Circuit (Atom : Set) where

open import Data.Nat using (â„•; _+_)
open import Data.Bool using () renaming (Bool to ğ”¹)
open import Data.Product using (_Ã—_)

open import PiWare.Synthesizable Atom
open import PiWare.Circuit.Core


-- "High-level" circuit types, packing the synthesis information
data â„‚ (Î± Î² : Set) {#Î± #Î² : â„•} : Set where
    Mkâ„‚ : â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ _ : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â†’ â„‚' Atom #Î± #Î² â†’ â„‚ Î± Î² {#Î±} {#Î²}

data â„‚* (Î± Î² : Set) {#Î± #Î² : â„•} : Set where
    Mkâ„‚* : â¦ƒ _ : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ _ : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â†’ â„‚'* Atom #Î± #Î² â†’ â„‚* Î± Î² {#Î±} {#Î²}


-- "Smart constructors"
_âŸ«_ : {Î± Î² Î³ : Set} {#Î± #Î² #Î³ : â„•}
      â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„
      â†’ â„‚ Î± Î² {#Î±} {#Î²} â†’ â„‚ Î² Î³ {#Î²} {#Î³} â†’ â„‚ Î± Î³ {#Î±} {#Î³}
_âŸ«_ â¦ƒ sÎ± = sÎ± â¦„ â¦ƒ sÎ³ = sÎ³ â¦„ (Mkâ„‚ câ‚) (Mkâ„‚ câ‚‚) = Mkâ„‚ â¦ƒ sÎ± â¦„ â¦ƒ sÎ³ â¦„ (câ‚ âŸ«' câ‚‚)

_||_ : {Î± Î³ Î² Î´ : Set} {#Î± #Î³ #Î² #Î´ : â„•}
       â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
       â†’ â„‚ Î± Î³ {#Î±} {#Î³} â†’ â„‚ Î² Î´ {#Î²} {#Î´} â†’  â„‚ (Î± Ã— Î²) (Î³ Ã— Î´) {#Î± + #Î²} {#Î³ + #Î´}
_||_ â¦ƒ sÎ± â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ´ â¦„ (Mkâ„‚ câ‚) (Mkâ„‚ câ‚‚) =
    Mkâ„‚  â¦ƒ â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦„  â¦ƒ â‡“ğ•â‡‘-Ã— â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ â¦„  (câ‚ |' câ‚‚)

infixr 9 _||_
infixl 8 _âŸ«_


repeatâ„‚ : {Î± Î² : Set} {#Î± #Î² : â„•} â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„
          â†’ â„‚ Î± Î² {#Î±} {#Î²} â†’ â„‚* Î± Î² {#Î±} {#Î²}
repeatâ„‚ â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ (Mkâ„‚ c) = Mkâ„‚* â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ (Comb c)

delayâ„‚ : {Î± Î² Î³ : Set} {#Î± #Î² #Î³ : â„•} â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„
         â†’ â„‚ (Î± Ã— Î³) (Î² Ã— Î³) {#Î± + #Î³} {#Î² + #Î³} â†’ â„‚* Î± Î² {#Î±} {#Î²}
delayâ„‚ â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ³ â¦„ (Mkâ„‚ c) = Mkâ„‚* â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ (DelayLoop c)

_âŸ«*_ : {Î± Î² Î³ : Set} {#Î± #Î² #Î³ : â„•} â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„
       â†’ â„‚* Î± Î² {#Î±} {#Î²} â†’ â„‚* Î² Î³ {#Î²} {#Î³} â†’ â„‚* Î± Î³ {#Î±} {#Î³}
_âŸ«*_ â¦ƒ sÎ± = sÎ± â¦„ â¦ƒ sÎ³ = sÎ³ â¦„ (Mkâ„‚* câ‚) (Mkâ„‚* câ‚‚) = Mkâ„‚* â¦ƒ sÎ± â¦„ â¦ƒ sÎ³ â¦„ (câ‚ âŸ«'* câ‚‚)

_|*_ : {Î± Î³ Î² Î´ : Set} {#Î± #Î³ #Î² #Î´ : â„•}
       â¦ƒ sÎ± : â‡“ğ•â‡‘ Î± {#Î±} â¦„ â¦ƒ sÎ³ : â‡“ğ•â‡‘ Î³ {#Î³} â¦„ â¦ƒ sÎ² : â‡“ğ•â‡‘ Î² {#Î²} â¦„ â¦ƒ sÎ´ : â‡“ğ•â‡‘ Î´ {#Î´} â¦„
       â†’ â„‚* Î± Î³ {#Î±} {#Î³} â†’ â„‚* Î² Î´ {#Î²} {#Î´} â†’  â„‚* (Î± Ã— Î²) (Î³ Ã— Î´) {#Î± + #Î²} {#Î³ + #Î´}
_|*_ â¦ƒ sÎ± â¦„ â¦ƒ sÎ³ â¦„ â¦ƒ sÎ² â¦„ â¦ƒ sÎ´ â¦„ (Mkâ„‚* câ‚) (Mkâ„‚* câ‚‚) =
    Mkâ„‚*  â¦ƒ â‡“ğ•â‡‘-Ã— â¦ƒ sÎ± â¦„ â¦ƒ sÎ² â¦„ â¦„  â¦ƒ â‡“ğ•â‡‘-Ã— â¦ƒ sÎ³ â¦„ â¦ƒ sÎ´ â¦„ â¦„  (câ‚ |'* câ‚‚)

infixr 7 _|*_
infixl 6 _âŸ«*_
